version: 2.1

executors:
  go-1_17:
    working_directory: '/go/src/github.com/influxdata/telegraf'
    resource_class: large
    docker:
      - image: 'quay.io/influxdb/telegraf-ci:1.18.1'
    environment:
      GOFLAGS: -p=4

jobs:
  docker-nightly:
    executor: go-1_17
    steps:
      - run:
          name: login to quay.io
          command: |
            echo ${QUAY_USER}
            QUAY_USER="blah"
            echo ${QUAY_USER}
            docker login --username="${QUAY_USER}" --password="${QUAY_PASS}" quay.io
      - run:
          name: clone influxdata/influxdata-docker
          command: git clone https://github.com/influxdata/influxdata-docker
      - run:
          name: build and push telegraf:nightly
          command: |
            cd influxdata-docker/telegraf/nightly
            docker build -t telegraf .
            docker tag telegraf quay.io/influxdb/telegraf:nightly
            docker image ls
            docker push quay.io/influxdb/telegraf:nightly
      - run:
          name: build and push telegraf:nightly-alpine
          command: |
            cd influxdata-docker/telegraf/nightly/alpine
            docker build -t telegraf-alpine .
            docker tag telegraf-alpine quay.io/influxdb/telegraf:nightly-alpine
            docker image ls
            docker push quay.io/influxdb/telegraf:nightly-alpine

workflows:
  version: 2
  check:
    jobs:
      - docker-nightly
